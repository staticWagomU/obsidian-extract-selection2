# Obsidian Zettelkasten Plugin - 新設計書

## 概要

Zettelkasten方式のノート管理を支援するObsidianプラグイン。選択範囲からノートを切り出す機能と、テンプレートから新規ノートを作成する機能を提供する。

---

## ノートタイプ（3種類）

| タイプ | 日本語名 | 説明 |
|--------|---------|------|
| **fleeting** | フリーティング | 素早い思いつき・アイデア |
| **literature** | リテラチャー | 書籍・記事・動画からの引用・要約 |
| **permanent** | パーマネント | 原子的で相互接続された知識単位 |

---

## コマンド一覧

### 1. Extract to Note（選択範囲をノートに切り出す）

**トリガー**: コマンドパレット / コンテキストメニュー

**フロー**:
```
1. テキストを選択
2. コマンド実行
3. ノートタイプ選択モーダル（Fleeting / Literature / Permanent）
4. エイリアス入力モーダル（オプション設定で表示/非表示）
5. 新規ノート作成 + 元の選択範囲をマークダウンリンクに置換
```

**オプション**:
- 共通インデントの削除（ネストしたリストを切り出す際に有用）

### 2. Create New Note（テンプレートから新規ノート作成）

**トリガー**: コマンドパレット

**フロー**:
```
1. コマンド実行
2. ノートタイプ選択モーダル（Fleeting / Literature / Permanent）
3. エイリアス入力モーダル（オプション設定で表示/非表示）
4. テンプレートから新規ノート作成 + 開く
```

---

## モーダル設計

### NoteTypeSelectModal（ノートタイプ選択）

```
┌─────────────────────────────────────┐
│  ノートタイプを選択                   │
├─────────────────────────────────────┤
│  💭 Fleeting  - 素早いメモ           │
│  📚 Literature - 文献からの引用       │
│  💎 Permanent  - 永続的な知識         │
└─────────────────────────────────────┘
```

### AliasInputModal（エイリアス入力）

```
┌─────────────────────────────────────┐
│  エイリアス名を入力                   │
├─────────────────────────────────────┤
│  [                              ]   │
│                                     │
│  ☑ 共通インデントを削除              │
│    （Extract時のみ表示）              │
│                                     │
│  [作成]              [キャンセル]    │
└─────────────────────────────────────┘
```

**動作**:
- エイリアスが空の場合: リンクはファイル名のみ `[20250111120000](20250111120000.md)`
- エイリアスがある場合: `[エイリアス名](20250111120000.md)`

---

## 設定画面

### フォルダ設定

| 設定項目 | デフォルト値 | 説明 |
|---------|------------|------|
| Fleeting フォルダ | （空） | Fleeting Note の保存先。空の場合はVault直下 |
| Literature フォルダ | （空） | Literature Note の保存先。空の場合はVault直下 |
| Permanent フォルダ | （空） | Permanent Note の保存先。空の場合はVault直下 |
| テンプレートフォルダ | （空） | テンプレートファイルの格納先 |

### ノートタイプ別設定

各ノートタイプ（Fleeting / Literature / Permanent）に対して:

| 設定項目 | デフォルト値 | 説明 |
|---------|------------|------|
| ファイル名形式 | `yyyyMMddHHmmss` | ファイル名のフォーマット |
| エイリアス入力を表示 | `true` | エイリアス入力モーダルを表示するか |
| テンプレートファイル | （空） | テンプレートファイルのパス |

**ファイル名形式オプション**:
- `yyyyMMddHHmmss` - 例: `20250111120000.md`
- `yyyy-MM-dd-HHmmss` - 例: `2025-01-11-120000.md`
- `カスタム` - Moment.js形式で自由に指定

**テンプレートが空の場合**:
- 空のマークダウンファイルに選択範囲（または空）を挿入

### 動作設定

| 設定項目 | デフォルト値 | 説明 |
|---------|------------|------|
| Extract後にノートを開く | `false` | 切り出し後に新規ノートを開くか |
| 共通インデント削除のデフォルト | `false` | インデント削除オプションの初期値 |

---

## テンプレート仕様

### プレースホルダー

| プレースホルダー | 説明 |
|-----------------|------|
| `{{content}}` | 選択範囲のテキスト（Extract時）/ 空（Create時） |
| `{{date}}` | 作成日（YYYY-MM-DD形式） |
| `{{time}}` | 作成時刻（HH:mm:ss形式） |
| `{{datetime}}` | 作成日時（YYYY-MM-DD HH:mm:ss形式） |
| `{{title}}` | ファイル名（拡張子なし） |
| `{{alias}}` | エイリアス名（入力された場合） |

### テンプレート例

**Fleeting テンプレート**:
```markdown
---
type: fleeting
created: {{datetime}}
aliases:
  - {{alias}}
---

{{content}}
```

**Literature テンプレート**:
```markdown
---
type: literature
created: {{datetime}}
source_type:
source_title:
source_author:
source_url:
aliases:
  - {{alias}}
---

## 引用/メモ

{{content}}

## 考察

```

**Permanent テンプレート**:
```markdown
---
type: permanent
created: {{datetime}}
aliases:
  - {{alias}}
tags:
  -
---

{{content}}

## 関連ノート

```

---

## 削除する既存機能

以下の機能は新設計で廃止:

1. **Promote Note（昇格機能）** - 不要
2. **Link Permanent（Structure接続）** - Structure廃止のため不要
3. **Quick Fleeting** - Create New Noteに統合
4. **Structure Note / Index** - 廃止
5. **SuggestionService** - Structure廃止のため不要
6. **ConnectionManager** - Structure廃止のため不要

### 残す機能

1. **OrphanView** - 他のノートからリンクされていない Permanent Note を表示
   - 新設計ではマークダウンリンクベースで孤立検出

---

## ファイル構成（予定）

```
src/
├── main.ts                     # プラグインエントリーポイント
├── settings.ts                 # 設定定義
├── types.ts                    # 型定義
├── i18n/                       # 国際化（既存を維持）
│   └── ...
├── services/
│   ├── note-creator.ts         # ノート作成サービス（新規）
│   ├── template-service.ts     # テンプレート処理（既存を改修）
│   ├── folder-service.ts       # フォルダ管理（既存を維持）
│   ├── frontmatter-service.ts  # フロントマター処理（既存を維持）
│   └── orphan-detector-service.ts # 孤立ノート検出（既存を改修）
└── ui/
    ├── modals/
    │   ├── note-type-modal.ts     # タイプ選択モーダル（新規）
    │   └── alias-input-modal.ts   # エイリアス入力モーダル（新規）
    ├── views/
    │   └── orphan-view.ts         # 孤立ノートビュー（既存を改修）
    └── settings-tab.ts            # 設定タブ（大幅改修）
```

---

## 実装フェーズ

### Phase 1: 基盤整理
- [ ] 不要なコード・ファイルの削除
- [ ] 型定義の更新（3タイプのみ）
- [ ] 設定画面の再設計

### Phase 2: コア機能実装
- [ ] NoteTypeSelectModal 実装
- [ ] AliasInputModal 実装
- [ ] NoteCreatorService 実装
- [ ] TemplateService の改修

### Phase 3: コマンド実装
- [ ] Extract to Note コマンド
- [ ] Create New Note コマンド
- [ ] 共通インデント削除機能

### Phase 4: UI改善
- [ ] OrphanView の改修（マークダウンリンクベースの孤立検出）
- [ ] コンテキストメニュー統合
- [ ] 設定画面の仕上げ

---

## 補足

### マークダウンリンク形式

本プラグインでは、Obsidian標準のWikiリンク `[[...]]` ではなく、マークダウンリンク形式を使用する。

**形式**: `[表示名](相対パス/ファイル名.md)`

**例**:
- エイリアスあり: `[私のメモ](Fleeting/20250111120000.md)`
- エイリアスなし: `[20250111120000](Fleeting/20250111120000.md)`
- フォルダ未設定時: `[20250111120000](20250111120000.md)`

### 共通インデント削除の仕様

選択範囲の各行から、最小共通インデント（タブまたはスペース）を削除する。

**例**:
```
入力:
    - Item 1
      - Sub item
    - Item 2

出力:
- Item 1
  - Sub item
- Item 2
```

### エイリアスとリンクの関係

| 設定 | エイリアス入力 | 生成されるリンク |
|-----|--------------|----------------|
| エイリアス表示ON | 入力あり | `[入力値](フォルダ/ファイル名.md)` |
| エイリアス表示ON | 入力なし | `[ファイル名](フォルダ/ファイル名.md)` |
| エイリアス表示OFF | - | `[ファイル名](フォルダ/ファイル名.md)` |
